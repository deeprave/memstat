name: Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version number (e.g., 1.0.0)'
        required: true
        type: string

jobs:
  create-release:
    name: Create Release
    runs-on: macos-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: latest-stable
    
    - name: Install just
      uses: extractions/setup-just@v2
    
    - name: Install create-dmg
      run: brew install create-dmg
    
    - name: Import Code Signing Certificates
      uses: apple-actions/import-codesign-certs@v2
      with:
        p12-file-base64: ${{ secrets.CERTIFICATES_P12 }}
        p12-password: ${{ secrets.CERTIFICATES_P12_PASSWORD }}
    
    - name: Generate version
      run: just version
    
    - name: Build Release
      run: just release
    
    - name: Code Sign Application
      env:
        CODESIGN_IDENTITY: ${{ secrets.CODESIGN_IDENTITY }}
      run: |
        ./Scripts/codesign_app.sh "build/Release/MemStat.app" "$CODESIGN_IDENTITY"
    
    - name: Notarize Application
      env:
        NOTARIZATION_USERNAME: ${{ secrets.NOTARIZATION_USERNAME }}
        NOTARIZATION_PASSWORD: ${{ secrets.NOTARIZATION_PASSWORD }}
        NOTARIZATION_TEAM_ID: ${{ secrets.NOTARIZATION_TEAM_ID }}
      run: |
        ./Scripts/notarize_app.sh \
          "build/Release/MemStat.app" \
          "$NOTARIZATION_USERNAME" \
          "$NOTARIZATION_PASSWORD" \
          "$NOTARIZATION_TEAM_ID"
    
    - name: Create DMG
      run: |
        ./Scripts/package_dmg_styled.sh \
          "build/Release/MemStat.app" \
          "MemStat-${{ github.event.inputs.version || github.ref_name }}.dmg"
    
    - name: Create ZIP
      run: |
        ./Scripts/package_zip.sh \
          "build/Release/MemStat.app" \
          "MemStat-${{ github.event.inputs.version || github.ref_name }}.zip"
    
    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        name: MemStat ${{ github.event.inputs.version || github.ref_name }}
        draft: false
        prerelease: false
        files: |
          MemStat-*.dmg
          MemStat-*.zip
        generate_release_notes: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}